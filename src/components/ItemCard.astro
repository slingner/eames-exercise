---
/**
 * ItemCard Component
 *
 * Displays a single collection item in a card format.
 * Shows all the normalized data fields we transformed.
 */
import type { Item } from '../types/item'

interface Props {
  item: Item
}

const { item } = Astro.props

// Helper to format field values
const formatValue = (value: any): string | null => {
  if (value == null) return null
  if (Array.isArray(value)) {
    return value.length > 0 ? value.join(', ') : null
  }
  if (typeof value === 'object') {
    // Handle nested objects like location, geo, series, edition
    const parts = Object.values(value).filter(Boolean)
    return parts.length > 0 ? parts.join(', ') : null
  }
  return String(value)
}

// Flag configurations
// 'as const' makes this array readonly and narrows types to literal values
// Without it: key would be type 'string', with it: key is 'possibleDuplicate' | 'prototype' | ...
const flagConfigs = [
  { key: 'possibleDuplicate', label: 'Possible Duplicate', className: 'duplicate' },
  { key: 'prototype', label: 'Prototype', className: 'prototype' },
  { key: 'needsResearch', label: 'Needs Research', className: 'research' },
  { key: 'needsReview', label: 'Needs Review', className: 'review' },
  { key: 'attributionUncertain', label: 'Attribution Uncertain', className: 'uncertain' },
  { key: 'materialsIncomplete', label: 'Materials Incomplete', className: 'incomplete' },
  { key: 'missingDimensions', label: 'Missing Dimensions', className: 'missing' },
] as const

// 'as keyof typeof item.flags' tells TypeScript that flag.key is a valid property name of ItemFlags
// This allows safe dynamic property access (e.g., item.flags['possibleDuplicate'])
const activeFlags = flagConfigs.filter(flag => item.flags?.[flag.key as keyof typeof item.flags])

// Detail fields
const detailFields = [
  { label: 'Date', value: item.date || 'Unknown', showUnknown: !item.date },
  { label: 'Type', value: item.objectType, showUnknown: false },
  { label: 'Department', value: item.department, showUnknown: false },
  { label: 'Materials', value: item.materials || 'Unknown', showUnknown: !item.materials },
  { label: 'Dimensions', value: item.dimensions || 'Unknown', showUnknown: !item.dimensions },
  { label: 'Accession', value: item.accessionNumber || 'Unknown', showUnknown: !item.accessionNumber },
]

// Additional fields to display (only if present)
const additionalFields = [
  { key: 'keywords', label: 'Keywords' },
  { key: 'notes', label: 'Notes' },
  { key: 'externalIds', label: 'External IDs', format: (v: any) => Object.entries(v).map(([k, val]) => `${k}: ${val}`).join(', ') },
  { key: 'description', label: 'Description' },
  { key: 'tags', label: 'Tags' },
  { key: 'creditLine', label: 'Credit Line' },
  { key: 'condition', label: 'Condition' },
  { key: 'location', label: 'Location' },
  { key: 'geo', label: 'Geographic Origin' },
  { key: 'series', label: 'Series' },
  { key: 'edition', label: 'Edition' },
  { key: 'rights', label: 'Rights' },
  { key: 'transcription', label: 'Transcription' },
  { key: 'inventoryLocation', label: 'Inventory Location' },
  { key: 'status', label: 'Status' },
  { key: 'variants', label: 'Variants', format: (v: any[]) => `${v.length} variant(s)` },
  { key: 'provenance', label: 'Provenance', format: (v: any[]) => `${v.length} record(s)` },
].filter(field => {
  // Type assertion needed: TypeScript can't verify field.key is a valid Item property at compile time
  // This is safe because we control the field definitions above
  const value = (item as any)[field.key]
  return value != null && (!Array.isArray(value) || value.length > 0)
})
---

<div class="card">
  <div class="card-header">
    <!--  class:list = astro conditional classes -->
    <h2 class:list={{ unknown: item.title === 'Unknown Title' }}>{item.title}</h2>
    {activeFlags.length > 0 && (
      <div class="flags">
        {activeFlags.map(flag => (
          <span class={`flag ${flag.className}`}>{flag.label}</span>
        ))}
      </div>
    )}
  </div>

  <p class="creator" class:list={{ unknown: !item.creator }}>
    {item.creator || 'Unknown'}
  </p>

  <dl class="details">
    {detailFields.map(field => (
      <div class="detail">
        <dt>{field.label}:</dt>
        <dd class:list={{ unknown: field.showUnknown }}>{field.value}</dd>
      </div>
    ))}
  </dl>

  {item.related && item.related.length > 0 && (
    <div class="related">
      <strong>Related:</strong>
      <ul>
        {item.related.map(rel => (
          <li>
            {rel.title || rel.objectId}
            <span class="relation-type">({rel.type})</span>
          </li>
        ))}
      </ul>
    </div>
  )}

  {additionalFields.length > 0 && (
    <>
      <button class="show-more-btn" data-item-id={item.id}>
        Additional Information
      </button>

      <dialog class="modal" data-modal-id={item.id}>
        <div class="modal-content">
          <div class="modal-header">
            <h3>{item.title}</h3>
            <button class="modal-close" aria-label="Close">&times;</button>
          </div>
          <dl class="additional-fields">
            {additionalFields.map(field => {
              // Type assertion needed: dynamic property access by key name
              const value = (item as any)[field.key]
              const displayValue = field.format ? field.format(value) : formatValue(value)
              return displayValue ? (
                <div class="additional-field">
                  <dt>{field.label}:</dt>
                  <dd>{displayValue}</dd>
                </div>
              ) : null
            })}
          </dl>
        </div>
      </dialog>
    </>
  )}
</div>

<script>
  // Event delegation - ONE listener for all interactions
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement

    // Open modal when "Additional Information" button clicked
    if (target.matches('.show-more-btn') || target.closest('.show-more-btn')) {
      const btn = target.closest('.show-more-btn') as HTMLElement
      const itemId = btn?.dataset.itemId
      if (itemId) {
        const modal = document.querySelector(`[data-modal-id="${itemId}"]`) as HTMLDialogElement
        modal?.showModal()
      }
    }

    // Close modal when X button clicked
    if (target.matches('.modal-close') || target.closest('.modal-close')) {
      const modal = target.closest('dialog') as HTMLDialogElement
      modal?.close()
    }

    // Close modal when clicking backdrop
    if (target.matches('dialog.modal')) {
      (target as HTMLDialogElement).close()
    }
  })
</script>

<style>
  .card {
    display: flex;
    flex-direction: column;
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    padding: var(--space-md);
    box-shadow: var(--card-shadow);
    transition: box-shadow 0.2s;
  }

  .card:hover {
    box-shadow: var(--card-shadow-hover);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-sm);
    margin-bottom: var(--space-xs);
  }

  .flags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
    align-items: flex-start;
    justify-content: flex-end;
  }

  .flag {
    display: inline-block;
    padding: 2px 8px;
    font-size: 0.75rem;
    font-weight: var(--font-weight-bold);
    border-radius: 4px;
    white-space: nowrap;
  }

  .flag.duplicate {
    background: var(--flag-duplicate-bg);
    color: var(--flag-duplicate-text);
    border: 1px solid var(--flag-duplicate-border);
  }

  .flag.prototype {
    background: var(--flag-prototype-bg);
    color: var(--flag-prototype-text);
    border: 1px solid var(--flag-prototype-border);
  }

  .flag.research {
    background: var(--flag-research-bg);
    color: var(--flag-research-text);
    border: 1px solid var(--flag-research-border);
  }

  .flag.review {
    background: var(--flag-review-bg);
    color: var(--flag-review-text);
    border: 1px solid var(--flag-review-border);
  }

  .flag.uncertain {
    background: var(--flag-uncertain-bg);
    color: var(--flag-uncertain-text);
    border: 1px solid var(--flag-uncertain-border);
  }

  .flag.incomplete {
    background: var(--flag-incomplete-bg);
    color: var(--flag-incomplete-text);
    border: 1px solid var(--flag-incomplete-border);
  }

  .flag.missing {
    background: var(--flag-missing-bg);
    color: var(--flag-missing-text);
    border: 1px solid var(--flag-missing-border);
  }

  h2 {
    margin: 0 0 var(--space-xs) 0;
    font-size: var(--font-size-lg);
    color: var(--color-text-primary);
  }

  h2.unknown {
    color: var(--color-text-muted);
    font-style: italic;
  }

  .creator {
    color: var(--color-text-secondary);
    font-style: italic;
    margin: 0 0 var(--space-sm) 0;
  }

  .creator.unknown {
    color: var(--color-text-muted);
    font-style: italic;
  }

  .details {
    margin: 0;
  }

  .detail {
    display: flex;
    gap: var(--space-xs);
    margin-bottom: var(--space-xs);
    font-size: var(--font-size-sm);
  }

  dt {
    font-weight: var(--font-weight-bold);
    color: var(--color-text-secondary);
    min-width: 90px;
  }

  dd {
    margin: 0;
    color: var(--color-text-secondary);
  }

  dd.unknown {
    color: var(--color-text-muted);
    font-style: italic;
  }

  .related {
    margin-top: var(--space-sm);
    padding-top: var(--space-sm);
    border-top: 1px solid var(--color-border);
    font-size: var(--font-size-sm);
  }

  .related strong {
    color: var(--color-text-secondary);
    font-weight: var(--font-weight-bold);
  }

  .related ul {
    margin: var(--space-xs) 0 0 0;
    padding-left: 1.2rem;
    color: var(--color-text-secondary);
  }

  .related li {
    margin-bottom: 0.25rem;
  }

  .relation-type {
    color: var(--color-text-muted);
    font-size: 0.85em;
  }

  .show-more-btn {
    width: 100%;
    margin-top: auto;
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-bold);
    cursor: pointer;
    transition: all 0.2s;
  }

  .show-more-btn:hover {
    background: var(--color-border);
    color: var(--color-text-primary);
  }

  .modal {
    border: none;
    border-radius: var(--border-radius);
    padding: 0;
    max-width: 600px;
    width: 90%;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  }

  .modal::backdrop {
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
  }

  .modal-content {
    padding: var(--space-lg);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--color-border);
  }

  .modal-header h3 {
    margin: 0;
    color: var(--color-text-primary);
    font-size: var(--font-size-lg);
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    line-height: 1;
    cursor: pointer;
    color: var(--color-text-muted);
    padding: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--border-radius);
    transition: all 0.2s;
  }

  .modal-close:hover {
    background: var(--color-bg);
    color: var(--color-text-primary);
  }

  .additional-fields {
    margin: var(--space-sm) 0 0 0;
  }

  .additional-field {
    display: flex;
    gap: var(--space-xs);
    margin-bottom: var(--space-xs);
    font-size: var(--font-size-sm);
    padding-left: var(--space-sm);
  }

  .additional-field dt {
    font-weight: var(--font-weight-bold);
    color: var(--color-text-secondary);
    min-width: 130px;
  }

  .additional-field dd {
    margin: 0;
    color: var(--color-text-secondary);
  }
</style>
